# Distributed trust management simulation logic

core/dtm_logic.go implements the distributed strust management logic for the simulation.

In the real world, in DTM, the RSU will collect and broadcast trust value offsets among the network, and gather the trust value offsets from the whole network to generate trust value.

In the simulator, the trust value offsets on every epochs are generated by the simulator and dispatch to every RSU, simulating real time trust value offsets sharing among RSU network.

## Routine

The distributed trust management is being simulated as follow:

1. at every slot, the simulator will randomly assign each vehicle with **trust value offsets** with **weight**, and then attach these offsets to each RSU according to which cross is the vehicle at;
2. at the end of epoch,  the simulator will gather all RSUs' trust value offsets storage, and then calculate trust value with ***weighted* trust value offsets **and **time factor**.

## Trust measurement over vehicle

The trust management measure the trustworthiness of vehicle by trust value. Trust value is generated from trust value offsets at the end of each epoch, and trust value offsets are generated and assigned to each vehicle at every slot.

### Trust value offset

Trust value offset, or trust rating, represents the vehicle's trustworthiness at a specific time slot, it also attached with a weight which related to the type of message as follow:

```go
// defined in shared/dtmtype/trustvalue.go
const (
	Routine = 0.5 // routinue message, like position and status broadcasting
	Crital   = 0.7 // critial on-road message, like traffic volume or normal event
	Fatal    = 0.9 // fatal on-road message, like traffic accident
)
```

The raw value of rating (trust value offset) is either -1, the vehicle is rated as misbehaving, or +1, the vehicle is rated as normal. And the effective value of trust value offset will be yielded from the raw value multiplied with rating weight.

### Trust value

Trust value represents the on-going vehicle's trustworthiness for a specific epoch. It is the sum of tuned trust value offsets from previous $N$ epochs. The range of trust value is $(-1, 1)$, when the trust value reaches below $0$, the vehicle will be considered as **misbehaving vehicle**.

When at the end of an epoch, RSUs query all trust value offsets of specific vehicles within an epoch. Trust value $V_i$ of vehicle $i$ in epoch $E$  can be calculated as follow, $S$ is the number of slots in $E$, $v_s$ is the sum of  trust value offsets for slot $s$, function $f$ is the time factor function, taking the start time $t_s$ of slot $s$ as parameter. 

$$
V_i=\sum^{S}_{s=0}{\frac{v_s}{S} \times f(t_s)},\quad V_i \in [-1, 1]
$$

## RSU behavior

RSU status can be **normal** or **compromised**, if the RSU is compromising, it will alter the trust value offsets that being broadcast. The detailed of how RSU performs is described at docs/simulation/rsu_logic.md.



## Simulation logic

### Trust value offsets generation

At every slot, the simulator will iterate through all the vehicles and:

1. check the ```MisbehavingVehicleBitMap``` in **simulation session** to see the vehicle is bad or not,
   1. if it is good vehicle, the simulator will rate the vehicle with +1 raw trust value offset
   2. if it is bad vehicle, there is still $1\%$ chance that the vehicle will not do evil, otherwise assign -1 raw trust value offset
2. randomly assign the rating with a message type (weight), the possibility of choices is the same as the weight for convenience,
3. save the trust value offsets to the RSU that vehicle located at. 

### Trust value generation

At the end of each epoch, the simulator will iterate through all the RSUs, collecting trust value offsets, and then calculate the trust value from the sum of offsets,

1. check the ```CompromisedRSUBitMap``` to see whether the RSU is compromised or not,
   1. if not compromised, the RSU will report true trust value offsets,
   2. if compromised, it will randomly choose from ```FlipTrustValueOffset``` and ```DropPositiveTrustValueOffset``` and report incorrect trust value offsets
   3. if compromised, it will also ```ForgeTrustValueOffest```, report trust value offsets that not stored in the RSU data field,
2. gather all the trust value offsets from RSUs, and then calculate the sum for each vehicle and generate trust value for it.